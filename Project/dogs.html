<!DOCTYPE html>
<html>
<head>
  <script src="https://fb.me/react-with-addons-15.1.0.js"></script>
  <script src="https://fb.me/react-dom-15.1.0.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@3"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/d3/4.2.3/d3.min.js">
    </script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <title>For the love of dog</title>
</head>
<body>
    <h1><center>Market for canine goods and services</center></h1>
  <div id="ui">
    
  </div>
    <div id="vis">
      <svg id="mapspace" width="1000" height="1000"></svg>
    </div>

<div id="vis"></div>

<script type="text/babel">
function generateMap(dat) {
  let bbox = dat[0];
  let geodat = dat[1];
  let mspc = document.getElementById('mapspace');
  mspc.selectAll(".geo").remove();
  mspc.selectAll(".rect").remove();

  let grp = mspc.append("g").attr("transform", "translate(150, 0)");
  let canvSz = [800, 800];
  grp.append("rect")
    .attr("x", 0).attr("y", 0)
    .attr("width", canvSz[0])
    .attr("height", canvSz[1])
    .attr("fill", "none").attr("stroke", "black");
  let proj = d3.geoMercator()
    .preclip(d3.geoClipRectangle(bbox[0], bbox[1], bbox[2], bbox[3]))
    .fitSize([canvSz[0], canvSz[1]], geodat);
  let path = d3.geoPath()
    .projection(proj);
  let color = colorRng.domain(colorDom);
  grp.selectAll(".geo")
    .data(geodat.features)
    .enter().append("path")
      .attr("class", "geo")
      .attr("d", path)
      .style("stroke", "grey")
      .style("fill", d => color(d.properties.numdogs));
  if (dat.length === 3) {
    grp.selectAll(".geo")
      .data(dat[2].features)
      .enter().append("path")
        .attr("class", "geo")
        .attr("d", path)
        .style("stroke", "red")
        .style("fill", "none");
  }
}
  var maxDogs = {'bor': 41661, 'comm': 7535, 'nta': 4990, 'tract': 1096};
  var colorRng = d3.scaleThreshold()
    .range(d3.schemeBlues[8]);
  var colorDom = d3.range(0, maxDogs['bor'], maxDogs['bor']/8);
  var mhoods = ['Battery Park City-Lower Manhattan',
      'Central Harlem North-Polo Grounds',
      'Central Harlem South', 'Chinatown', 'Clinton',
      'East Harlem North', 'East Harlem South', 'East Village',
      'Gramercy', 'Hamilton Heights',
      'Hudson Yards-Chelsea-Flatiron-Union Square',
      'Lenox Hill-Roosevelt Island', 'Lincoln Square',
      'Lower East Side', 'Manhattanville', 'Marble Hill-Inwood',
      'Midtown-Midtown South', 'Morningside Heights',
      'Murray Hill-Kips Bay',
      'SoHo-TriBeCa-Civic Center-Little Italy',
      'Stuyvesant Town-Cooper Village', 'Turtle Bay-East Midtown',
      'Upper East Side-Carnegie Hill', 'Upper West Side',
      'Washington Heights North', 'Washington Heights South',
      'West Village', 'Yorkville'];
  class GeoSelector extends React.Component {
    constructor(props) {
      super(props);
      this.state = {
        geoType: 'nta',
        borough: 'Manhattan',
        boroughSub: 'full',
        showTracts: 'no'
      };
      this.handleChange = this.handleChange.bind(this);
      this.handleSubmit = this.handleSubmit.bind(this);
      this.initBor = this.initBor.bind(this);
      this.actSubarea = this.actSubarea.bind(this);
      this.toggleTracts = this.toggleTracts.bind(this);
      this.initSub = this.initSub.bind(this);
    }

  handleChange(event) {
    if (this.hasOwnProperty('target')) {
      this.setState({
        [event.target.name]: event.target.value
      });
    }
  }

  handleSubmit(event) {
    let spec = `/makemap/${this.state.geoType}/${this.state.borough}/` +
               `${this.state.boroughSub}/${this.state.showTracts}`
    spec = `http://localhost:8002${spec}`
    d3.json(spec, function (dat) {
      console.log('got map');
      generateMap(dat);
    });
  }
  
  initSub(event) {
    //this.handleChange();
    this.setState({["borough"]: event.target.value});
    this.setState({["subarea"]: "full"});
    let cont = document.getElementByName("subarea");
    while (cont.size > 1) {
      cont.remove(1);
    }
    if (this.state.borough === "full") {
      cont.disabled = true;
    } else {
      cont.disabled = false;
      let optlist = '';
      if (this.state.geoType === 'nta') {
        optlist = `/listhoods/${this.state.borough}`
      } else {
        optlist = `/listcomms/${this.state.borough}`;
      }
      optlist = `http://localhost:8002${optlist}`;
      console.log(optlist);
      d3.json(optlist, function (dat) {
        dat.map(function (opt) {
          let addopt = createElement("option");
          addopt.value = opt;
          addopt.text = opt;
          cont.add(addopt);
        });
      });
      this.toggleTracts();
    }
  }

  actSubarea(event) {
    console.log(event.target.value);
    this.setState({["boroughSub"]: event.target.value});
    console.log(this.state.boroughSub);
    this.toggleTracts(event);
  }
  
  toggleTracts(event) {
  //this.handleChange();
    let cont = document.getElementById("selTracts");
    if (this.state.boroughSub === "full") {
      cont.disabled = true;
    } else {
      cont.disabled = false;
    }
    this.setState({["tractson"]: "no"});
  }

  initBor(event) {
  //    this.handleChange();
    this.setState({["initBor"]: event.target.value});
    this.setState({["borough"]: "full"});
    colorDom = d3.range(0, maxDogs[this.state.initBor],
        maxDogs[this.state.initBor]/8);
    this.initSub();
  }
  
  render() {
    var boards = {"manh":12, "bronx":15, "brook":18, "queens":14, "staten":3};
    return (
      <form onSubmit={this.handleSubmit}>
        <label>
          Select Geography &nbsp; <br />
          Geography type &nbsp; 
          <select 
            name="geoType" disabled="true"
            value={this.state.geoType} 
             onChange={this.initBor}>
            <option value="bor">Borough</option>
            <option value="comm">Community District</option>
	    <option value="nta">Neighborhood</option>
          </select>
          &nbsp; &nbsp;
	  District/Hood &nbsp;
	  <select
	     name="subarea" id="selSubarea"
	     value={this.state.boroughSub}
	     onChange={this.toggleTracts}>
	    <option value="full">Full borough</option>
	  </select><br />
          Borough &nbsp; 
	  <select
	     name="borough" disabled="true"
	     value={this.state.borough}
	     onChange={this.initSub}>
	    <option value="full">Full city</option>
	    <option value="Manhattan">Manhattan</option>
	    <option value="Bronx">Bronx</option>
	    <option value="Brooklyn">Brooklyn</option>
	    <option value="Queens">Queens</option>
	    <option value="Staten Island">Staten Island</option>
	  </select>
	  &nbsp; &nbsp;
	  Show Tracts &nbsp;
	  <select
	     name="tractson" disabled="true" id="selTracts"
	     value={this.state.tractson}
	     onChange={this.handleChange}>
	    <option value="tractno">No</option>
	    <option value="tractyes">Yes</option>
	  </select>
          &nbsp; &nbsp; 
        </label>
        <input type="submit" value="Update" />
      </form>
    );
  }
}
      
ReactDOM.render(
  <div>
    <GeoSelector />
  </div>,
  document.getElementById('ui')
);
  var cont = document.getElementById('selSubarea');
  mhoods.map(function (d) {
    let addopt = document.createElement("option");
    addopt.value = d;
    addopt.text = d;
    cont.add(addopt);  
  });
</script>
</body>
</html>
